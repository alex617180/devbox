#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/_lib.sh"; load_env; ensure_up
proj="${1:-}"; port="${2:-}"
[[ -z "$proj" ]] && { echo "usage: vite <project> [port-from-${VITE_PORT_RANGE}]"; exit 1; }
# ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ñ€Ñ‚ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½ â€” Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ VITE_PORT, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½
[[ -z "$port" ]] && port="${VITE_PORT:-}" || true
[[ -z "$port" ]] && port="$(freeport "$VITE_PORT_RANGE")" || true
[[ -z "$port" ]] && { echo "âŒ ĞĞµÑ‚ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ² Ğ² $VITE_PORT_RANGE Ğ¸ VITE_PORT Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½"; exit 1; }

# Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
docker compose -f "$DEVBOX_DIR/docker-compose.yml" exec -T -u 0 workspace bash -lc 'mkdir -p /var/log/devbox && chmod 0777 /var/log/devbox'

# Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¸Ğ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ½Ğ° npm-ĞºÑÑˆ, ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
docker compose -f "$DEVBOX_DIR/docker-compose.yml" exec -T -u 0 workspace bash -lc '
  wd="/var/www/'"$proj"'";
  uid=$(stat -c %u "$wd" 2>/dev/null || echo 1000)
  gid=$(stat -c %g "$wd" 2>/dev/null || echo 1000)
  mkdir -p /home/dev/.npm
  chown -R "$uid:$gid" /home/dev/.npm 2>/dev/null || true
'

dexd "/var/www/$proj" sh -lc \
  "for pid in \$(ps -ef | grep -E '[n]ode .*vite' | awk '{print \$2}'); do cwd=\$(readlink -f /proc/\$pid/cwd 2>/dev/null||echo); [[ \"\$cwd\" == \"\$(pwd)\"* ]] && kill \"\$pid\" 2>/dev/null||true; done; \
   npm i >/dev/null 2>&1 || true; \
   npm run dev -- --host --strictPort --port ${port} \
     >>/var/log/devbox/vite-${proj//\//_}-${port}.log 2>&1"

echo "âœ… Vite (${proj}) â†’ http://localhost:${port}"
echo "ğŸ“ logs: $DEVBOX_DIR/logs/vite-${proj//\//_}-${port}.log"
