#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/_lib.sh"
proj="${1:-}"; ver="${2:-}"
if [[ -z "$proj" ]]; then echo "usage: dev <project> [83|74]"; exit 1; fi

if [[ -n "$ver" ]]; then
  case "$ver" in
    83|8.3|8.3-cli|workspace83) export DEVBOX_PHP=83 ;;
    74|7.4|7.4-cli|workspace74) export DEVBOX_PHP=74 ;;
  esac
fi

load_env; ensure_up
# –µ—Å–ª–∏ –∑–∞–¥–∞–Ω—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Ä—Ç—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö; –∏–Ω–∞—á–µ –∞–≤—Ç–æ–ø–æ–¥–±–æ—Ä –∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
app_port="${APP_PORT:-}"
vite_port="${VITE_PORT:-}"
[[ -z "$app_port" ]] && app_port="$(freeport "$APP_PORT_RANGE")"  || true
[[ -z "$vite_port" ]] && vite_port="$(freeport "$VITE_PORT_RANGE")" || true
[[ -z "$app_port" ]] && { echo "‚ùå –ù–µ—Ç –ø–æ—Ä—Ç–æ–≤ –≤ $APP_PORT_RANGE –∏ APP_PORT –Ω–µ –∑–∞–¥–∞–Ω"; exit 1; }
[[ -z "$vite_port" ]] && { echo "‚ùå –ù–µ—Ç –ø–æ—Ä—Ç–æ–≤ –≤ $VITE_PORT_RANGE –∏ VITE_PORT –Ω–µ –∑–∞–¥–∞–Ω"; exit 1; }
"$(dirname "$0")/serve" "$proj" "$app_port"
"$(dirname "$0")/vite"  "$proj" "$vite_port"
echo -e "\nüöÄ ${proj}\n  Laravel: http://localhost:${app_port}\n  Vite:    http://localhost:${vite_port}"
