#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/_lib.sh"
proj="${1:-}"; ver="${2:-}"
if [[ -z "$proj" ]]; then echo "usage: stop <project> [83|74]"; exit 1; fi

if [[ -n "$ver" ]]; then
  case "$ver" in
    83|8.3|8.3-cli|workspace83) export DEVBOX_PHP=83 ;;
    74|7.4|7.4-cli|workspace74) export DEVBOX_PHP=74 ;;
  esac
fi

load_env; ensure_up

dex "/var/www/$proj" bash -lc '
  # artisan serve — убиваем только процессы из текущей директории проекта
  for pid in $(ps -ef | grep -E "[p]hp .*artisan serve --host=0\.0\.0\.0" | awk "{print \$2}"); do
    cwd=$(readlink -f /proc/$pid/cwd 2>/dev/null || echo "")
    [[ "$cwd" == "$(pwd)"* ]] && kill "$pid" 2>/dev/null || true
  done

  # php -S fallback — по cwd
  for pid in $(ps -ef | grep -E "[p]hp -S 0\.0\.0\.0:[0-9]+ -t public" | awk "{print \$2}"); do
    cwd=$(readlink -f /proc/$pid/cwd 2>/dev/null || echo "")
    [[ "$cwd" == "$(pwd)"* ]] && kill "$pid" 2>/dev/null || true
  done

  # vite — по cwd
  for pid in $(ps -ef | grep -E "[n]ode .*vite" | awk "{print \$2}"); do
    cwd=$(readlink -f /proc/$pid/cwd 2>/dev/null || echo "")
    [[ "$cwd" == "$(pwd)"* ]] && kill "$pid" 2>/dev/null || true
  done

  rm -f /tmp/serve-'"${proj//\//_}"'-*.log /tmp/vite-'"${proj//\//_}"'-*.log 2>/dev/null || true
'
echo "🛑 Остановлено: ${proj}"
