#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/_lib.sh"; load_env; ensure_up
proj="${1:-}"; [[ -z "$proj" ]] && { echo "usage: stop <project>"; exit 1; }

dex "/var/www/$proj" bash -lc '
  # artisan serve â€” ÑƒĞ±Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑÑ‹ Ğ¸Ğ· Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
  for pid in $(ps -ef | grep -E "[p]hp .*artisan serve --host=0\.0\.0\.0" | awk "{print \$2}"); do
    cwd=$(readlink -f /proc/$pid/cwd 2>/dev/null || echo "")
    [[ "$cwd" == "$(pwd)"* ]] && kill "$pid" 2>/dev/null || true
  done

  # php -S fallback â€” Ğ¿Ğ¾ cwd
  for pid in $(ps -ef | grep -E "[p]hp -S 0\.0\.0\.0:[0-9]+ -t public" | awk "{print \$2}"); do
    cwd=$(readlink -f /proc/$pid/cwd 2>/dev/null || echo "")
    [[ "$cwd" == "$(pwd)"* ]] && kill "$pid" 2>/dev/null || true
  done

  # vite â€” Ğ¿Ğ¾ cwd
  for pid in $(ps -ef | grep -E "[n]ode .*vite" | awk "{print \$2}"); do
    cwd=$(readlink -f /proc/$pid/cwd 2>/dev/null || echo "")
    [[ "$cwd" == "$(pwd)"* ]] && kill "$pid" 2>/dev/null || true
  done

  rm -f /tmp/serve-'"${proj//\//_}"'-*.log /tmp/vite-'"${proj//\//_}"'-*.log 2>/dev/null || true
'
echo "ğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: ${proj}"
